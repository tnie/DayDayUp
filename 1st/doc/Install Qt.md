
Qt [官方下载页面](https://www.qt.io/offline-installers)  离线安装包只支持 5.12.12 ，后续版本不再提供离线安装包。

使用在线安装工具，默认只展示最新的三个 Qt 版本供用户安装。右侧筛选项，**勾选 Archive** 后筛选就会列出旧版本的 Qt 。

# 从源码构建 Qt

如果要在不联网的设备上使用新版本 Qt ，还是需要掌握如何编译 Qt 源码！
之前想断点进 Qt 源码调试一直没成功，借这次机会一并实现。

从源码开始构建 Qt https://doc.qt.io/qt-5/windows-building.html

按部就班做就可以，Step 3 的 ICU 和 ANGLE 三方库并不是必要项目，其他中文教程中常见的 perl/python 也不需要。

- SSL 可能也不需要，但我电脑之前其他项目需要已经配置了，未作关注

```bat
CALL "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64
SET _ROOT=D:\Portable\Qt\src\qt-everywhere-src-5.15.16\
SET _TOOL=D:\Portable\Qt\build\tool
SET _PYTHON=C:\Users\Administrator\AppData\Local\Programs\Python\Python313\
:: 以上
SET _CLANG=%_TOOL%\libclang
SET _JOM=%_TOOL%\jom
SET _PERL=%_TOOL%\strawberry-perl-5.38.0.1-64bit-portable
SET _CMAKE=%_TOOL%\cmake-3.24.2-windows-x86_64\bin
:: 即使只编译 qtbase ，也需要全量包中的工具
SET PATH=%_ROOT%\qtbase\bin;%_ROOT%\gnuwin32\bin;%PATH%
SET PATH=%_PERL%\perl\site\bin;%_PERL%\perl\bin;%_PERL%\c\bin;%PATH%
SET PATH=%_CMAKE%;%_PYTHON%;%_CLANG%\bin;%_JOM%;%PATH%
::SET LLVM_INSTALL_DIR=%_CLANG%
cd %_ROOT%
SET _ROOT=
SET _CLANG=
SET _JOM=
SET _PERL=
SET _PYTHON=
SET _CMAKE=
SET _TOOL=
```

Step 4 提供的配置命令太保守，我们可以更激进一些，将不需要的目录全部跳过

```bat
configure.bat -debug -nomake examples -nomake tests -opensource ^
-skip qt3d -skip qtactiveqt -skip qtandroidextras -skip qtcharts -skip qtconnectivity -skip qtdatavis3d -skip qtdeclarative -skip qtdoc -skip qtgamepad -skip qtgraphicaleffects -skip qtimageformats -skip qtlocation -skip qtlottie -skip qtmacextras -skip qtmultimedia -skip qtnetworkauth -skip qtpurchasing -skip qtquick3d -skip qtquickcontrols -skip qtquickcontrols2 -skip qtquicktimeline -skip qtremoteobjects -skip qtscript -skip qtscxml -skip qtsensors -skip qtserialbus -skip qtserialport -skip qtspeech -skip qtsvg -skip qttools -skip qttranslations -skip qtvirtualkeyboard -skip qtwayland -skip qtwebchannel -skip qtwebengine -skip qtwebglplugin -skip qtwebsockets -skip qtwebview -skip qtwinextras -skip qtx11extras 
？-no-dbus -no-opengl 
```

即便如此，在 x240 上通过 nmake 构建依然在一小时以上（报错中止了）

改用 jom ，半小时构建完毕。

> jom is a clone of nmake to support the execution of multiple independent commands in parallel. 

暂时不构建文档 Step 5

## 只构建 qtbase

调整 `configure.bat` 的各项参数删减模块太麻烦，可以只下载 qtbase 模块源码，从源头杜绝编译其他模块的可能性。

编写脚本完成下载-构建-安装 Qt 5.15.x，用于学习 Qt 核心的元对象系统、事件循环、信号和槽函数。

## Qt 4.8.7

Qt4.8.7 安装包，自带源码和 pdb 调试文件，结合 MSVC2010 断点调试理解源码。

比查看、学习 Qt5.x 的源码方便很多：但这个版本终究是太老了，

1. Qt5.15.x 没有离线安装包
2. Qt5.12.x 虽然有离线安装包，但没有 pdb 调试文件
3. 单独下载 pdb 文件后与源码版本不一致，断点位置偏移

使用 QtCreator 默认的模板创建项目，调试时提示“调试器未设置”，所以使用 MSVC2010 。

安装 qt-vsaddin-msvc2010-2.5.2-rev.01 ？

# 不用 CDB 调试

使用 Qt Creator 调试 msvc 构建的程序时，必须安装 CDB （没有单独的安装包，要把 WDK 全部装上，占用 2.1G (lll￢ω￢)

那我只用 Qt Creator 借用 gdb 调试

我改用 MSVC 调试 qt 程序就不用 cdb 了吧？

# cannot run 'rc.exe'

在安装 Qt 5.12.12 + MSVC 2015 之后，再次安装 MSVC2019 ，可能会碰到 LNK1158: cannot run 'rc.exe' 错误造成编译失败。

社区关于此问题的 [讨论和 workaround](https://forum.qt.io/topic/90839/lnk1158-cannot-run-rc-exe) 

排查发现 `echo %WindowsSdkDir%` 环境变量指向的 `C:\Program Files (x86)\Windows Kits\10\` 子目录内下没有 rc.exe 

刨根问底 [rc.exe no longer found in VS 2015 Command Prompt][1]

# 构建过程

qmake 基于 .pro 项目文件生成 makefile 。

> qmake generates a Makefile based on the information in a project file. 

nmake.exe 基于 makefile 中描述的指令构建项目。

> The Microsoft Program Maintenance Utility (NMAKE.EXE) is a command-line tool included with Visual Studio. It builds projects based on commands that are contained in a description file, usually called a makefile.

jom.exe 基于 nmake 增加了并发构建的功能。

> jom is a clone of nmake to support the execution of multiple independent commands in parallel. 

uic.exe 将 .ui 用户界面文件转换成 .h 头文件。

> The uic reads an XML format user interface definition (.ui) file as generated by Qt Designer and creates a corresponding C++ header file or Python source file.

moc.exe 用于……

cl.exe 用来控制 c/c++ 编译器和链接器。

> cl.exe is a tool that controls the Microsoft C++ (MSVC) C and C++ compilers and linker. cl.exe can be run only on operating systems that support Microsoft Visual Studio for Windows.


[1]:https://stackoverflow.com/questions/43847542/rc-exe-no-longer-found-in-vs-2015-command-prompt